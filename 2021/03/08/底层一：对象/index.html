<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>底层一：OC对象 · Hexo</title><meta name="description" content="OC对象本质是C++的结构体：因为对象涉及到不同类型，只有结构体能存储不同的结构体
123456789101112131415161718- (void)test &amp;#123;    &amp;#125;其实是系统会传递两个参数过来// self 方法调用者// _cmd 方法名，等价于当前方法的selec"><meta name="keywords" content=""><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">生活</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">聊聊</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/tags">Tags</a></li><li><a href="/tags/index.html"></a></li><li class="soc"><a href="http://example.com/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://example.com" rel="noopener noreferrer">John Doe</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>底层一：OC对象</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2021-03-08</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/底层/" title="底层" class="a-tag">底层</a><span>&nbsp;</span></span></p><p class="post-abstract"><p><strong>OC对象本质是C++的结构体：因为对象涉及到不同类型，只有结构体能存储不同的结构体</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)test &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">其实是系统会传递两个参数过来</span><br><span class="line"></span><br><span class="line"><span class="comment">// self 方法调用者</span></span><br><span class="line"><span class="comment">// _cmd 方法名，等价于当前方法的selector，既@selector(test)</span></span><br><span class="line">- (<span class="keyword">void</span>)testId:(<span class="keyword">id</span>)<span class="keyword">self</span> _cmd:(SEL)_cmd &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//转化成CPP</span></span><br><span class="line"><span class="keyword">void</span> test(MJPerson* <span class="keyword">self</span>, SEL _cmd) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2><span id="oc-dui-xiang-de-ben-zhi">OC对象的本质</span><a href="#oc-dui-xiang-de-ben-zhi" class="header-anchor">#</a></h2><h4><span id="jiang-oc-dai-ma-zhuan-huan-cheng-wei-c-c-dai-ma">将OC代码转换成为C\C++代码</span><a href="#jiang-oc-dai-ma-zhuan-huan-cheng-wei-c-c-dai-ma" class="header-anchor">#</a></h4><p>这里最好新建项目创建两个类进行转换，因为要遵从一些上下文，否则会转换失败</p>
<blockquote>
<p>切换到文件目录，使用命令行<br><code>clang -rewrite-objc xxxx.m -o xxx.cpp</code><br>直接切换到iOS下64位系统可以使用的CPP代码<br><code>xcrun  -sdk  iphoneos  clang  -arch  arm64  -rewrite-objc  xxxx.m  -o  xxx.cpp </code></p>
</blockquote>
<h5><span id="cha-kan-oc-yuan-ma-di-zhi">查看OC源码地址</span><a href="#cha-kan-oc-yuan-ma-di-zhi" class="header-anchor">#</a></h5><p><a target="_blank" rel="noopener" href="https://opensource.apple.com/tarballs/">OC源码 数字最大的是最新的 objc 4</a></p>
<blockquote>
<p><code>Core Foundation </code>硬性规定对象占用十六字节</p>
</blockquote>
<h5><span id="mian-shi-ti">面试题：</span><a href="#mian-shi-ti" class="header-anchor">#</a></h5><p><strong>一个NSObject对象占用多少内存？</strong></p>
<blockquote>
<p>系统分配了<code>16个字节</code>给<code>NSObject</code>对象（通过<code>malloc_size</code>函数获得）</p>
<p>但<code>NSObject</code>对象内部只使用了<code>8个字节</code>的空间（<code>64bit</code>环境下，可以通过<code>class_getInstanceSize</code>函数获得）</p>
</blockquote>
<p><code>OC</code> 转换为<code>C++</code>后，查看对象的实现，一般是<code>类型_IMPL</code>形式，<code>Student</code>转换后就是 <code>Student_IMPL</code></p>
<p>查看<code>class_getInstanceSize</code>的实现（<code>.mm</code> 文件），在<code>Objc 4</code> 中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;malloc/malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NSObject Implementation</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="built_in">NSObject_IMPL</span> &#123;</span><br><span class="line">    Class isa;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//typedef struct objc_class *Class; // 64位占8个字节</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// insert code here...</span></span><br><span class="line">        <span class="built_in">NSObject</span> *obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%zd&quot;</span>,class_getInstanceSize([<span class="built_in">NSObject</span> <span class="keyword">class</span>])); <span class="comment">// 8</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%zd&quot;</span>, malloc_size((__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)obj)); <span class="comment">// 16</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">class_getInstanceSize</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> cls-&gt;alignedInstanceSize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Class&#x27;s ivar size rounded up to a pointer-size boundary. (返回类的成员变量的大小)</span></span><br><span class="line">    <span class="function"><span class="keyword">uint32_t</span> <span class="title">alignedInstanceSize</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> word_align(unalignedInstanceSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">alloc 实际是调用 allocWithZone</span><br><span class="line"></span><br><span class="line">--------------------- 类： NSObject.mm ---------------------</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Replaced by ObjectAlloc</span><br><span class="line">+ (id)allocWithZone:(struct _NSZone *)zone &#123;</span><br><span class="line">    return _objc_rootAllocWithZone(self, (malloc_zone_t *)zone);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------- 类： Objc-runtime-new.mm ---------------------</span><br><span class="line"></span><br><span class="line">_objc_rootAllocWithZone(Class cls, malloc_zone_t *zone __unused)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; allocWithZone under __OBJC2__ ignores the zone parameter</span><br><span class="line">    return _class_createInstanceFromZone(cls, 0, nil,</span><br><span class="line">                                         OBJECT_CONSTRUCT_CALL_BADALLOC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------- 类 objc-runtime-new.mm  ---------------------</span><br><span class="line"></span><br><span class="line">static ALWAYS_INLINE id</span><br><span class="line">_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone,</span><br><span class="line">                              int construct_flags &#x3D; OBJECT_CONSTRUCT_NONE,</span><br><span class="line">                              bool cxxConstruct &#x3D; true,</span><br><span class="line">                              size_t *outAllocatedSize &#x3D; nil)</span><br><span class="line">&#123;</span><br><span class="line">    ............</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    size_t size;</span><br><span class="line"></span><br><span class="line">    size &#x3D; cls-&gt;instanceSize(extraBytes);</span><br><span class="line"></span><br><span class="line">    if (outAllocatedSize) *outAllocatedSize &#x3D; size;</span><br><span class="line"></span><br><span class="line">    id obj;</span><br><span class="line">    if (zone) &#123;</span><br><span class="line">        obj &#x3D; (id)malloc_zone_calloc((malloc_zone_t *)zone, 1, size);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        obj &#x3D; (id)calloc(1, size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ............</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--------------------- 类：objc-runtime-new.h  ---------------------</span><br><span class="line">inline size_t instanceSize(size_t extraBytes) const &#123;</span><br><span class="line">        if (fastpath(cache.hasFastInstanceSize(extraBytes))) &#123;</span><br><span class="line">            return cache.fastInstanceSize(extraBytes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        size_t size &#x3D; alignedInstanceSize() + extraBytes;</span><br><span class="line">        &#x2F;&#x2F; CF requires all objects be at least 16 bytes.</span><br><span class="line">        if (size &lt; 16) size &#x3D; 16;   &#96;&#96;</span><br><span class="line">        return size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>if (size &lt; 16) size = 16;</code> 主要是这句，是<code>Core Foundation</code>框架 硬性规定的</p>
<p><strong>查看过程：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> 1. 将OC转换成C++代码，可以看到的NSObject的本质是一个结构体，其中包含了一个isa指针，占用了8个字节</span><br><span class="line">&#x2F;&#x2F; NSObject Implementation</span><br><span class="line">struct NSObject_IMPL &#123;</span><br><span class="line">    Class isa; &#x2F;&#x2F; 8个字节</span><br><span class="line">&#125;;</span><br><span class="line"> 2. 查看源码</span><br><span class="line"> size_t class_getInstanceSize(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cls) return 0;</span><br><span class="line">    return cls-&gt;alignedInstanceSize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Class&#39;s ivar size rounded up to a pointer-size boundary.</span><br><span class="line">&#x2F;&#x2F; 获取到类的实例对象的成员变量所占用的大小</span><br><span class="line">    uint32_t alignedInstanceSize() &#123;</span><br><span class="line">        return word_align(unalignedInstanceSize());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>查看alloc分配内存的过程</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.在源码中搜索allocWithZone，找到实现函数 </span></span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">_objc_rootAllocWithZone(Class cls, <span class="keyword">malloc_zone_t</span> *zone)</span><br><span class="line">&#123;</span><br><span class="line">    id obj;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    <span class="comment">// allocWithZone under __OBJC2__ ignores the zone parameter</span></span><br><span class="line">    (<span class="keyword">void</span>)zone;</span><br><span class="line">    obj = class_createInstance(cls, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">if</span> (!zone) &#123;</span><br><span class="line">        obj = class_createInstance(cls, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        obj = class_createInstanceFromZone(cls, <span class="number">0</span>, zone);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(!obj)) obj = callBadAllocHandler(cls);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 查看class_createInstance函数</span></span><br><span class="line">id </span><br><span class="line">class_createInstance(Class cls, <span class="keyword">size_t</span> extraBytes)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> _class_createInstanceFromZone(cls, extraBytes, nil);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">_class_createInstanceFromZone(Class cls, <span class="keyword">size_t</span> extraBytes, <span class="keyword">void</span> *zone, </span><br><span class="line">                              <span class="keyword">bool</span> cxxConstruct = <span class="literal">true</span>, </span><br><span class="line">                              <span class="keyword">size_t</span> *outAllocatedSize = nil)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span> nil;</span><br><span class="line"></span><br><span class="line">    assert(cls-&gt;isRealized());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read class&#x27;s info bits all at once for performance</span></span><br><span class="line">    <span class="keyword">bool</span> hasCxxCtor = cls-&gt;hasCxxCtor();</span><br><span class="line">    <span class="keyword">bool</span> hasCxxDtor = cls-&gt;hasCxxDtor();</span><br><span class="line">    <span class="keyword">bool</span> fast = cls-&gt;canAllocNonpointer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> size = cls-&gt;instanceSize(extraBytes);</span><br><span class="line">    <span class="keyword">if</span> (outAllocatedSize) *outAllocatedSize = size;</span><br><span class="line"></span><br><span class="line">    id obj;</span><br><span class="line">    <span class="keyword">if</span> (!zone  &amp;&amp;  fast) &#123;</span><br><span class="line">        obj = (id)<span class="built_in">calloc</span>(<span class="number">1</span>, size);</span><br><span class="line">        <span class="keyword">if</span> (!obj) <span class="keyword">return</span> nil;</span><br><span class="line">        obj-&gt;initInstanceIsa(cls, hasCxxDtor);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (zone) &#123;</span><br><span class="line">            obj = (id)malloc_zone_calloc ((<span class="keyword">malloc_zone_t</span> *)zone, <span class="number">1</span>, size);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            obj = (id)<span class="built_in">calloc</span>(<span class="number">1</span>, size);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!obj) <span class="keyword">return</span> nil;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use raw pointer isa on the assumption that they might be </span></span><br><span class="line">        <span class="comment">// doing something weird with the zone or RR.</span></span><br><span class="line">        obj-&gt;initIsa(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cxxConstruct &amp;&amp; hasCxxCtor) &#123;</span><br><span class="line">        obj = _objc_constructOrFree(obj, cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 3. 查看cls-&gt;instanceSize(extraBytes);</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">instanceSize</span><span class="params">(<span class="keyword">size_t</span> extraBytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">size_t</span> size = alignedInstanceSize() + extraBytes;</span><br><span class="line">        <span class="comment">// CF requires all objects be at least 16 bytes.</span></span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">16</span>) size = <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">可以看出Core Foundation框架要求对象至少占用<span class="number">16</span>个字节</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cfd1eb2296a748fca91f6ccf6d033caf~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-11 下午3.20.26.png"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb7fceadadca427f8113fc1d78da19b4~tplv-k3u1fbpfcp-watermark.image" alt="test_xcodeproj.png"></p>
<p><code>计算机中的正数用源码表示，负数用补码表示，而负数的补码是其反码+1 所以出现了-128 简单的说为了避免-0，负数的算法结果是每位都加了1</code></p>
<h5><span id="ios-shi-xiao-duan-mo-shi-zai-nei-cun-zhong-cong-gao-wei-xiang-di-wei-du-qu-shu-ju">iOS是<code>小端</code>模式，在内存中从高位向低位读取数据</span><a href="#ios-shi-xiao-duan-mo-shi-zai-nei-cun-zhong-cong-gao-wei-xiang-di-wei-du-qu-shu-ju" class="header-anchor">#</a></h5><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e54c9730cf8043fe8d749f20ad8fa8a9~tplv-k3u1fbpfcp-watermark.image" alt="Interview01-OC对象的本质_xcodeproj.png"></p>
<p><strong>内存对齐</strong>： 结构体的大小必须是<code>最大成员</code>大小的倍数<br><strong>iOS内部操作系统</strong>：内存分配是16的倍数</p>
<h2><span id="instance-dui-xiang-shi-li-dui-xiang-class-dui-xiang-lei-dui-xiang-meta-class-dui-xiang-yuan-lei-dui-xiang">instance对象（实例对象）、class对象（类对象）、meta_class对象（元类对象）</span><a href="#instance-dui-xiang-shi-li-dui-xiang-class-dui-xiang-lei-dui-xiang-meta-class-dui-xiang-yuan-lei-dui-xiang" class="header-anchor">#</a></h2><h4><span id="instance-dui-xiang-shi-li-dui-xiang">instance对象（实例对象）</span><a href="#instance-dui-xiang-shi-li-dui-xiang" class="header-anchor">#</a></h4><ul>
<li><p><code>instance对象</code>在内存中存储的信息包括 ：<code>isa</code>指针（也是成员变量）、其他<code>成员变量</code></p>
</li>
<li><p><code>isa</code>的地址，就是<code>instance对象</code>的地址，因为<code>isa</code>总是在首部</p>
</li>
</ul>
<h4><span id="class-dui-xiang-lei-dui-xiang">class对象（类对象）</span><a href="#class-dui-xiang-lei-dui-xiang" class="header-anchor">#</a></h4><p>每个类在内存中有且只有一个<code>class</code>对象</p>
<p>runtime 源码 在objc4 里面</p>
<h2><span id="isa-he-superclass">isa和superClass</span><a href="#isa-he-superclass" class="header-anchor">#</a></h2><h2><span id="instance-dui-xiang-class-dui-xiang-meta-class-dui-xiang">instance对象、class对象、meta_class对象</span><a href="#instance-dui-xiang-class-dui-xiang-meta-class-dui-xiang" class="header-anchor">#</a></h2><h4><span id="instance-dui-xiang">instance对象</span><a href="#instance-dui-xiang" class="header-anchor">#</a></h4><h5><span id="mei-ge-instance-dui-xiang-chuang-jian-chu-lai-tong-guo-alloc-init-chuang-jian-fang-fa-du-zhi-you-yi-fen-yin-wei-fang-fa-shi-xiang-tong-de-fang-dao-lei-de-fang-fa-lie-biao-zhong-bu-fang-zai-dui-xiang-de-jie-gou-ti-zhong">每个instance对象创建出来（通过<code>alloc</code>、<code>init</code>创建），方法都只有一份，因为方法是相同的，放到类的方法列表中 （不放在<code>对象</code>的结构体中）</span><a href="#mei-ge-instance-dui-xiang-chuang-jian-chu-lai-tong-guo-alloc-init-chuang-jian-fang-fa-du-zhi-you-yi-fen-yin-wei-fang-fa-shi-xiang-tong-de-fang-dao-lei-de-fang-fa-lie-biao-zhong-bu-fang-zai-dui-xiang-de-jie-gou-ti-zhong" class="header-anchor">#</a></h5><blockquote>
<p> 一个类的类对象（class对象）是唯一的，在内存中只会开辟一份存储空间</p>
</blockquote>
<h4><span id="isa-zhi-zhen-xiang-shun-xu">isa指针向顺序</span><a href="#isa-zhi-zhen-xiang-shun-xu" class="header-anchor">#</a></h4><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f8518f7ad7842919185a1737b227b45~tplv-k3u1fbpfcp-zoom-1.image" alt="屏幕快照 2018-07-15 18.33.02.png"></p>
<h4><span id="class-dui-xiang-de-superclass-zhi-zhen">class对象的superClass指针</span><a href="#class-dui-xiang-de-superclass-zhi-zhen" class="header-anchor">#</a></h4><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e19e11d1f61a4c9a970e6af2b0de8894~tplv-k3u1fbpfcp-zoom-1.image" alt="屏幕快照 2018-07-15 19.18.56.png"></p>
<h4><span id="isa-he-superclass-zong-jie">isa和superClass总结</span><a href="#isa-he-superclass-zong-jie" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Class object_getClass(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (obj) return obj-&gt;getIsa();</span><br><span class="line">    else return Nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/561733e1ad5a4d4294d327f9c23d364c~tplv-k3u1fbpfcp-zoom-1.image" alt="屏幕快照 2018-07-16 22.53.37.png"></p>
<ul>
<li>注意点：基类的元类的superClass指针，指向基类的类对象</li>
</ul>
<h4><span id="isa-zhi-zhen-xi-jie">isa指针细节</span><a href="#isa-zhi-zhen-xi-jie" class="header-anchor">#</a></h4><p>ISA_MASK 去源码里面获取</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cbb894957aa4bb8b66d040f8bbce6ed~tplv-k3u1fbpfcp-zoom-1.image" alt="屏幕快照 2018-07-18 23.19.09.png"></p>
<h5><span id="jian-ce-fang-shi">检测方式</span><a href="#jian-ce-fang-shi" class="header-anchor">#</a></h5><h6><span id="shi-li-dui-xiang">实例对象</span><a href="#shi-li-dui-xiang" class="header-anchor">#</a></h6><p>定义一个类<code>MJPerson</code>，创建一个<code>instance对象</code>(实例对象)和一个<code>Class对象</code>（类对象），断点打印对应的<code>isa</code>地址。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e57246c8b8e4e1a9b18921eca26f54e~tplv-k3u1fbpfcp-zoom-1.image" alt="打印指针 2018-07-18 23.23.01.png"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/afe0d96a154140bb82491579b459d1c6~tplv-k3u1fbpfcp-watermark.image" alt="未命名.png"></p>
<h6><span id="lei-dui-xiang">类对象</span><a href="#lei-dui-xiang" class="header-anchor">#</a></h6><p>因为<code>类对象</code>的isa指针无法通过程序直接打印，可以创建一个结构体模仿<code>类对象</code>的实现，然后进行打印</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mj_objc_class</span> &#123;</span></span><br><span class="line">    Class isa;</span><br><span class="line">    Class superclass;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mj_objc_class</span> *<span class="title">personClass</span> =</span> (__bridge struct mj_objc_class *)([MJPerson class]);</span><br><span class="line">从而得出</span><br><span class="line">personClass-&gt;isa &amp; ISA_MASK：<span class="number">0x00000001000014c8</span> = meta_class </span><br></pre></td></tr></table></figure>

<h4><span id="kui-tan-struct-objc-class-de-jie-gou-lei-dui-xiang-he-yuan-lei-dui-xiang-dui-ying-de-jie-gou-ti">窥探struct objc_class的结构 (类对象和元类对象对应的结构体)</span><a href="#kui-tan-struct-objc-class-de-jie-gou-lei-dui-xiang-he-yuan-lei-dui-xiang-dui-ying-de-jie-gou-ti" class="header-anchor">#</a></h4><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fca529bcb6c043b4b23050c5292b169e~tplv-k3u1fbpfcp-watermark.image" alt="01-OC语法.png"></p>
<h4><span id="super-he-superclass-de-qu-bie">super 和 superClass的区别</span><a href="#super-he-superclass-de-qu-bie" class="header-anchor">#</a></h4><ul>
<li>self就是给谁发消息，不一定是当前类，谁接受消息，self就代表谁</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Test</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#import &quot;NSObject+Test.h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Test</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//+ (void)test</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    NSLog(@&quot;+[NSObject test] - %p&quot;, self);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">- (<span class="keyword">void</span>)test</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// self就是给谁发消息，不一定是当前类，谁接受消息，self就代表谁</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;-[NSObject test] - %p&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MJPerson</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MJPerson</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//+ (void)test</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    NSLog(@&quot;+[MJPerson test] - %p&quot;, self);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[MJPerson class] - %p&quot;</span>, [MJPerson <span class="keyword">class</span>]);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[NSObject class] - %p&quot;</span>, [<span class="built_in">NSObject</span> <span class="keyword">class</span>]);</span><br><span class="line">        <span class="comment">// OC对象的调用方法，就是发送消息，发送过程中不会注意到是类方法还是对象方法</span></span><br><span class="line">        [MJPerson test];</span><br><span class="line">        <span class="comment">// objc_msgSend([MJPerson class], @selector(test))</span></span><br><span class="line">        <span class="comment">// isa -&gt; superclass -&gt; suerpclass -&gt; superclass -&gt; .... superclass == nil</span></span><br><span class="line">        </span><br><span class="line">        [<span class="built_in">NSObject</span> test];</span><br><span class="line">        <span class="comment">// objc_msgSend([NSObject class], @selector(test))</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 打印结果</span></span><br><span class="line"><span class="comment">         [MJPerson class] - 0x1000011e0</span></span><br><span class="line"><span class="comment">         [NSObject class] - 0x7fff8d775140</span></span><br><span class="line"><span class="comment">         // self就是给谁发消息，不一定是当前类，谁接受消息，self就代表谁,所以这里的打印虽然发生在NSObject的分类中，但是其实消息是发送给MJPerson的，所以打印出的self是MJPerson的类对象</span></span><br><span class="line"><span class="comment">         [NSObject test] - 0x1000011e0</span></span><br><span class="line"><span class="comment">         [NSObject test] - 0x7fff8d775140</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a target="_blank" rel="noopener" href="http://twitter.com/home?status=http://example.com/2021/03/08/底层一：对象/%20Hexo%20底层一：OC对象" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2021/03/08/%E5%BA%95%E5%B1%82%E4%BA%8C%EF%BC%9AKVO%E3%80%81KVC/" title="底层二：KVO、KVC">Next post: 底层二：KVO、KVC&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://example.com" rel="noopener noreferrer">John Doe</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>