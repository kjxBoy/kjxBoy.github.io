<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>底层五：Runtime · Hexo</title><meta name="description" content="OC 的消息机制#
OC 的消息机制 ： OC中的方法调用其实都是转成了objc_msgSend函数的调用，给receiver（方法调用者）发送了一条消息（selector方法名）


Objective-C是一门动态性比较强的编程语言，跟C、C++等语言有着很大的不同


Runtime API提"><meta name="keywords" content=""><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">生活</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">聊聊</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/tags">Tags</a></li><li><a href="/tags/index.html"></a></li><li class="soc"><a href="http://example.com/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://example.com" rel="noopener noreferrer">John Doe</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>底层五：Runtime</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2021-03-08</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/底层/" title="底层" class="a-tag">底层</a><span>&nbsp;</span></span></p><p class="post-abstract"><h2><span id="oc-de-xiao-xi-ji-zhi">OC 的消息机制</span><a href="#oc-de-xiao-xi-ji-zhi" class="header-anchor">#</a></h2><blockquote>
<p><code>OC 的消息机制</code> ： OC中的方法调用其实都是转成了<code>objc_msgSend</code>函数的调用，给<code>receiver（方法调用者）</code>发送了一条<code>消息（selector方法名）</code></p>
</blockquote>
<blockquote>
<p><code>Objective-C</code>是一门<code>动态性</code>比较强的编程语言，跟C、C++等语言有着很大的不同</p>
</blockquote>
<blockquote>
<p><code>Runtime API</code>提供的接口基本都是<code>C语言</code>的，源码由<code>C\C++\汇编语言</code>编写</p>
</blockquote>
<h3><span id="isa-xiang-jie">isa详解</span><a href="#isa-xiang-jie" class="header-anchor">#</a></h3><h4><span id="gong-yong-ti-union">共用体(union)</span><a href="#gong-yong-ti-union" class="header-anchor">#</a></h4><p><code>定义：</code>所有参数占用同一块内存</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> year </span><br><span class="line">    <span class="keyword">int</span> month</span><br><span class="line">    <span class="keyword">int</span> day </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 其中year 、 month、day分别占用自己的内存，每个占用4个字节</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> year </span><br><span class="line">    <span class="keyword">int</span> month</span><br><span class="line">    <span class="keyword">int</span> day </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 其中year 、 month、day是同一块内存，一共占用4个字节</span></span><br></pre></td></tr></table></figure>

<p> 定义一个共用体，并使用 </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">char</span> bits; <span class="comment">// 一个字节</span></span><br><span class="line">        <span class="comment">// 结构体仅仅是增加了可读性，完全可以删掉，结构体也只占一位,位置完全有Mask决定</span></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="keyword">char</span> tall : <span class="number">1</span>; <span class="comment">// 只占一位，在最右边</span></span><br><span class="line">            <span class="keyword">char</span> rich : <span class="number">1</span>; <span class="comment">// 只占一位</span></span><br><span class="line">            <span class="keyword">char</span> handsome : <span class="number">1</span>; <span class="comment">// 只占一位</span></span><br><span class="line">            <span class="keyword">char</span> thin : <span class="number">1</span>; <span class="comment">// 只占一位, 在最左边</span></span><br><span class="line">            <span class="comment">// 0000 thin / handsome / rich / tall</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; _tallRichHandsome;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bits 和 结构体，都是一个字节，使用同样的一块一字节内容，相互影响，但是因为只是用bits，所以struct只是为了可读性，没有作用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// `1 &lt;&lt; 0` 表示`1左移0位` 即 `0b 0000 0001` </span></span><br><span class="line"><span class="comment">// `mask`表示掩码，执行`按位与`操作</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJTallMask (1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJRichMask (1&lt;&lt;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJHandsomeMask (1&lt;&lt;2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJThinMask (1&lt;&lt;3)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MJPerson</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTall:(<span class="built_in">BOOL</span>)tall;</span><br><span class="line">- (<span class="keyword">void</span>)setRich:(<span class="built_in">BOOL</span>)rich;</span><br><span class="line">- (<span class="keyword">void</span>)setHandsome:(<span class="built_in">BOOL</span>)handsome;</span><br><span class="line">- (<span class="keyword">void</span>)setThin:(<span class="built_in">BOOL</span>)thin;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isTall;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isRich;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isHandsome;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isThin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;MJPerson.h&quot;</span></span></span><br><span class="line"><span class="comment">// `mask`表示掩码 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJTallMask (1&lt;&lt;0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJRichMask (1&lt;&lt;1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJHandsomeMask (1&lt;&lt;2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MJThinMask (1&lt;&lt;3)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MJPerson</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">char</span> bits;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="keyword">char</span> tall : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> rich : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> handsome : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> thin : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; _tallRichHandsome;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MJPerson</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTall:(<span class="built_in">BOOL</span>)tall</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (tall) &#123;</span><br><span class="line">        _tallRichHandsome.bits |= MJTallMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 按位取反</span></span><br><span class="line">        _tallRichHandsome.bits &amp;= ~MJTallMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isTall</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 两个&quot;!&quot;，将类型强转为BOOL类型</span></span><br><span class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; MJTallMask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setRich:(<span class="built_in">BOOL</span>)rich</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (rich) &#123;</span><br><span class="line">        _tallRichHandsome.bits |= MJRichMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _tallRichHandsome.bits &amp;= ~MJRichMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isRich</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 两个&quot;!&quot;，将类型强转为BOOL类型</span></span><br><span class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; MJRichMask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setHandsome:(<span class="built_in">BOOL</span>)handsome</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (handsome) &#123;</span><br><span class="line">        _tallRichHandsome.bits |= MJHandsomeMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _tallRichHandsome.bits &amp;= ~MJHandsomeMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isHandsome</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 两个&quot;!&quot;，将类型强转为BOOL类型</span></span><br><span class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; MJHandsomeMask);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setThin:(<span class="built_in">BOOL</span>)thin</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (thin) &#123;</span><br><span class="line">        _tallRichHandsome.bits |= MJThinMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _tallRichHandsome.bits &amp;= ~MJThinMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isThin</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 两个&quot;!&quot;，将类型强转为BOOL类型</span></span><br><span class="line">    <span class="keyword">return</span> !!(_tallRichHandsome.bits &amp; MJThinMask);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4><span id="isa-ben-zhi">isa本质</span><a href="#isa-ben-zhi" class="header-anchor">#</a></h4><blockquote>
<p>在<code>arm64</code>架构之前，<code>isa</code>就是一个普通的指针，存储着<code>Class、Meta-Class</code>对象的内存地址</p>
</blockquote>
<blockquote>
<p>从<code>arm64</code>架构开始，对<code>isa</code>进行了优化，变成了一个<code>共用体（union）</code>结构，还使用<code>位域(二进制位)</code>来存储更多的信息</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8c9acd43d1594a589da1cb2ad487b419~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.33.55.png"></p>
<p>根据共用体知识，这里的内容全部存储在<code>uintptr_t bits</code>中，结构体只是为了更方便阅读，没有任何作用（可以删掉），共用体后面的数字代表占了<code>多少位</code></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cbb894957aa4bb8b66d040f8bbce6ed~tplv-k3u1fbpfcp-zoom-1.image" alt="屏幕快照 2018-07-18 23.19.09.png"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ARM64 simulators have a larger address space, so use the ARM64e</span></span><br><span class="line"><span class="comment">// scheme even when simulators build for ARM64-not-e.</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">if</span> __has_feature(ptrauth_calls) || TARGET_OS_SIMULATOR(模拟器)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x007ffffffffffff8ULL</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br></pre></td></tr></table></figure>
<p>可以根据<code>ISA_MASK</code>，推断出要取出<code>共用体</code>中的33位，用来存储<code>类对象、元类对象</code>的地址</p>
<blockquote>
<p><code>nonpointer ：</code></p>
<p> <code>0</code> 代表普通的指针，存储着<code>Class、Meta-Class对象</code>的内存地址<br> <code>1</code>代表优化过，使用位域存储更多的信息</p>
</blockquote>
<hr>
<blockquote>
<p><code>has_assoc(has_associatedObject)</code><br>是否有设置过<code>关联对象</code>，如果没有，释放时会更快</p>
</blockquote>
<hr>
<blockquote>
<p><code>has_cxx_dtor</code><br>是否有<code>C++</code>的<code>析构函数</code>（.cxx_destruct），如果没有，释放时会更快</p>
<hr>
<p><code>shiftcls</code><br>存储着<code>Class、Meta-Class对象</code>的<code>内存地址</code>信息</p>
<hr>
<p><code>magic</code><br>用于在调试时分辨对象是否未完成<code>初始化</code></p>
<hr>
<p><code>weakly_referenced</code><br>是否有被<code>弱引用</code>指向过，如果没有，释放时会更快</p>
<hr>
<p><code>deallocating</code><br>对象是否正在释放</p>
<hr>
<p><code>extra_rc</code>（extra_retainCount）<br>里面存储的值是引用计数器的数值减去1（如果引用计数器存储的是10，这里存的就是9）</p>
<hr>
<p><code>has_sidetable_rc</code><br>引用计数器是否过大无法存储在<code>isa</code>中<br>如果为1，那么引用计数会存储在一个叫<code>SideTable</code>的类的属性中</p>
</blockquote>
<h3><span id="class-de-jie-gou-lei-dui-xiang-he-yuan-lei-dui-xiang-de-jie-gou-ti">Class的结构(类对象和元类对象的结构体)</span><a href="#class-de-jie-gou-lei-dui-xiang-he-yuan-lei-dui-xiang-de-jie-gou-ti" class="header-anchor">#</a></h3><p><code>成员变量</code>和<code>属性</code>的定义</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@interfacePerson :<span class="built_in">NSObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//定义成员变量</span></span><br><span class="line">    int_age;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 属性</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) <span class="built_in">NSString</span>  *name;</span><br></pre></td></tr></table></figure>

<p><code>Class 的结构</code></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb982108f3c44aa2aaad19fac8681ece~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.34.50.png"></p>
<blockquote>
<p>这张图上的<code>Class_rw_t</code> 中</p>
<p><code>xxx_list_t &lt;method_list_t、property_list_t、protocol_list_t&gt;</code></p>
<p>在源码中可以看到是对应的数组的形式</p>
<p><code>xxx_array_t &lt;method_array_t、property_array_t、protocol_array_t&gt;</code></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// Be warned that Symbolication knows the layout of this structure.</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">method_array_t</span> methods;</span><br><span class="line">    <span class="keyword">property_array_t</span> properties;</span><br><span class="line">    <span class="keyword">protocol_array_t</span> protocols;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><code>class_rw_t的结构</code></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d062afe4c7a74a4f9d2e7de8ed14817e~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.35.14.png"></p>
<p><code>class_ro_t的结构</code><br><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b28b1727c8054a7aa2ef7f39fbc38600~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.35.32.png"></p>
<ul>
<li><p><code>class_rw_t</code>里面的<code>methods</code>、<code>properties</code>、<code>protocols</code>是二维数组，是<code>可读可写</code>的，包含了类的初始内容、分类的内容。<code>class_ro_t</code>的内容会被放到方法实现类数组<code>methods</code>的栈底，<code>分类</code>的方法会加载到栈顶的位置</p>
</li>
<li><p><code>class_ro_t</code>里面的<code>baseMethodList</code>、<code>baseProtocols</code>、<code>ivars</code>、<code>baseProperties</code>是一维数组，是<code>只读</code>的，包含了类的初始内容</p>
</li>
</ul>
<p><code>method_t</code>是对方法\函数的封装</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12bb663991f046c198f707ef459b894a~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.36.21.png"></p>
<p><code>IMP</code>代表函数的具体实现</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/337859cd2b884a0baefc85e0ae658c5e~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.36.47.png"></p>
<p><code>SEL</code>代表方法名（就是个名字），一般叫做选择器</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/37655a7808054f448eb2ec9fa991264b~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.37.13.png"></p>
<blockquote>
<ul>
<li>可以通过<code>@selector()</code>和<code>sel_registerName()</code>获得</li>
<li>可以通过<code>sel_getName()</code>和<code>NSStringFromSelector()</code>转成字符串</li>
<li>不同类中相同名字的方法，所对应的方法选择器是相同的 </li>
</ul>
</blockquote>
<p><code>type</code>包含了函数返回值、参数编码的字符串(<code>iOS</code>中提供了一个叫做<code>@encode</code>的指令，可以将具体的类型表示成字符串编码)</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b74a0ce1643a4ef8aec0434655ac7398~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.37.38.png"></p>
<h3><span id="fang-fa-huan-cun">方法缓存</span><a href="#fang-fa-huan-cun" class="header-anchor">#</a></h3><blockquote>
<p><code>[person test]</code>相当于给<code>person</code>发一个<code>test</code>消息，<code>person</code>去对应的<code>类对象</code>的<code>method_array_t* methods</code> 去遍历查找方法，但是因为<code>methods</code>是一个二维数据，如果没找到还要通过<code>superClass</code>指针去父类里面找，遍历查找的效率还是比较底的</p>
</blockquote>
<p><code>Class</code>内部结构中有个方法缓存<code>cache_t</code>，用<code>散列表（哈希表）&lt;底层是个动态数组&gt;</code>来缓存曾经调用过的方法，可以提高方法的查找速度</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/761b36d09a6741af8f34f74400c9387f~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.38.03.png"></p>
<ul>
<li><p><code>散列表</code> 使用<code>函数名（SEL）</code>和<code>mask_t _mask(散列表长度减一)</code> 按位<code>与</code>的方式生成<code>key</code>，如果<code>key</code>相同了，直接将<code>key</code>数值减一，存到散列表中，取出过程中是先去取数据，如果发现取出的数据跟当前的<code>key</code>不一致，也要减一，如果减到零，就变成<code>_mask</code>(散列表最大值),继续减一</p>
</li>
<li><p>达到快速查找方法的实现。以空间换取时间</p>
</li>
<li><p>一旦动态数组扩容，会清空里面的数据</p>
</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/35bd9cc86acd4efeaa9c1e50c23d6c2c~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.38.30.png"></p>
<h3><span id="objc-msgsend-zhi-xing-liu-cheng">objc_msgSend执行流程</span><a href="#objc-msgsend-zhi-xing-liu-cheng" class="header-anchor">#</a></h3><p>OC中的<code>方法调用</code>(<code>消息机制</code>)，其实都是转换为<code>objc_msgSend</code>函数的调用, 就是给方法<code>调用者(reciver)</code>发送消息</p>
<p><code>objc_messageSend</code> 三大阶段</p>
<blockquote>
<p>1.消息发送</p>
<p>2.动态方法解析</p>
<p>3.消息转发</p>
</blockquote>
<p><strong>objc_msgSend执行流程 – 源码跟读</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bcbdbc6c03d54ea59292b22cc8e5af49~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.39.21.png"></p>
<p><strong>objc_msgSend执行流程01-<code>消息发送</code></strong></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b66ea94132d64ca7b424bf409608e9a0~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.39.48.png"></p>
<p><strong>objc_msgSend执行流程02-<code>动态方法解析</code></strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/024506283ae4459ebd554450f2bd1f5f~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.40.00.png"><br><strong>动态添加方法</strong></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/37787f94266c4669ad5b22e21beb5ba9~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.40.31.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+ (BOOL)resolveClassMethod:(SEL)sel &#123;</span><br><span class="line">    if (sel &#x3D;&#x3D; @selector(test)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 在元类方法列表里面存放的类方法，如果找不到，会转向最后的父类查找对象方法</span><br><span class="line">        &#x2F;&#x2F; Method  method &#x3D; class_getInstanceMethod(self, @selector(other));</span><br><span class="line">        </span><br><span class="line">        Method  method &#x3D; class_getClassMethod(self, @selector(other));</span><br><span class="line">        </span><br><span class="line">        class_addMethod(object_getClass(self),</span><br><span class="line">                        sel,</span><br><span class="line">                        method_getImplementation(method),</span><br><span class="line">                        method_getTypeEncoding(method));</span><br><span class="line">        &#x2F;&#x2F; 从源码可以看出， 这里返回YES或者NO都可以</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return [super resolveClassMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从源码可以看出，在调用完动态方法解析后，会调用goto函数，再次进行<code>消息发送</code>，因为已经在类中添加了方法，所以可以在类对象（或元类对象中找到方法）</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class_addMethod(object_getClass(<span class="keyword">self</span>),</span><br><span class="line">                      sel,</span><br><span class="line">                      method_getImplementation(method),</span><br><span class="line">                      method_getTypeEncoding(method));</span><br></pre></td></tr></table></figure>


<p><strong>objc_msgSend的执行流程03-<code>消息转发</code></strong></p>
<blockquote>
<p>当前类无法处理消息，就将消息转发给其他类进行处理</p>
</blockquote>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12906464486b4acb80cef3d088ba6667~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-18 上午10.41.05.png"></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test)) &#123;</span><br><span class="line">        <span class="comment">// objc_msgSend([[MJCat alloc] init], aSelector)</span></span><br><span class="line">        <span class="keyword">return</span> [[MJCat alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法签名：返回值类型、参数类型</span></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test:name:)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">&quot;v@:&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSInvocation封装了一个方法调用，包括：方法调用者、方法名、方法参数</span></span><br><span class="line"><span class="comment">//    anInvocation.target 方法调用者</span></span><br><span class="line"><span class="comment">//    anInvocation.selector 方法名</span></span><br><span class="line"><span class="comment">//    [anInvocation getArgument:NULL atIndex:0]</span></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//    anInvocation.target = [[MJCat alloc] init];</span></span><br><span class="line"><span class="comment">//    [anInvocation invoke];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//[anInvocation invokeWithTarget:[[MJCat alloc] init]];</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,<span class="built_in">NSStringFromSelector</span>(anInvocation.selector));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 有返回值的处理</span></span><br><span class="line">- (<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (aSelector == <span class="keyword">@selector</span>(test:)) &#123;</span><br><span class="line"><span class="comment">//        return [NSMethodSignature signatureWithObjCTypes:&quot;v20@0:8i16&quot;];</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">&quot;i@:i&quot;</span>];</span><br><span class="line"><span class="comment">//        return [[[MJCat alloc] init] methodSignatureForSelector:aSelector];</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)forwardInvocation:(<span class="built_in">NSInvocation</span> *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 参数顺序：receiver、selector、other arguments</span></span><br><span class="line"><span class="comment">//    int age;</span></span><br><span class="line"><span class="comment">//    [anInvocation getArgument:&amp;age atIndex:2];</span></span><br><span class="line"><span class="comment">//    NSLog(@&quot;%d&quot;, age + 10);</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// anInvocation.target == [[MJCat alloc] init]</span></span><br><span class="line">    <span class="comment">// anInvocation.selector == test:</span></span><br><span class="line">    <span class="comment">// anInvocation的参数：15</span></span><br><span class="line">    <span class="comment">// [[[MJCat alloc] init] test:15]</span></span><br><span class="line">    </span><br><span class="line">    [anInvocation invokeWithTarget:[[MJCat alloc] init]];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    [anInvocation getReturnValue:&amp;ret];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%d&quot;</span>, ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="super-de-ben-zhi">super的本质</span><a href="#super-de-ben-zhi" class="header-anchor">#</a></h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;Student.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[self class] = %@&quot;</span>, [<span class="keyword">self</span> <span class="keyword">class</span>]); <span class="comment">// Student</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[self superclass] = %@&quot;</span>, [<span class="keyword">self</span> superclass]); <span class="comment">// Person</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;--------------------------------&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// objc_msgSendSuper(&#123;self, [MJPerson class]&#125;, @selector(class));</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[super class] = %@&quot;</span>, [<span class="keyword">super</span> <span class="keyword">class</span>]); <span class="comment">// Student</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;[super superclass] = %@&quot;</span>, [<span class="keyword">super</span> superclass]); <span class="comment">// Person</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>将<code>Student</code>中的方法 <code>[super run]</code> 转换成<code>CPP</code>代码，来探究<code>super</code>的本质</li>
</ol>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转换前</span></span><br><span class="line">- (<span class="keyword">void</span>)run</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> run];   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换后</span></span><br><span class="line">    objc_msgSendSuper (</span><br><span class="line">                        (__rw_objc_super)&#123;</span><br><span class="line">                                <span class="keyword">self</span>,</span><br><span class="line">                            class_getSuperclass(objc_getClass(<span class="string">&quot;Student&quot;</span>))</span><br><span class="line">                        &#125;, <span class="keyword">@selector</span>(run)</span><br><span class="line">                    );</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>2.将转换后的代码进行抽取、查找得出如下代码</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">rw_objc_super</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">    self,</span><br><span class="line">    class_getSuperclass(objc_getClass(<span class="string">&quot;Student&quot;</span>)) <span class="comment">// 根据函数可以看出是Peron</span></span><br><span class="line">&#125;</span><br><span class="line">objc_msgSendSuper(arg, @selector(run))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>3.查找 <code>objc_super</code> 的源码</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_super</span> &#123;</span></span><br><span class="line">    __unsafe_unretained _Nonnull id receiver; <span class="comment">// 消息接受者</span></span><br><span class="line">    __unsafe_unretained _Nonnull Class super_class; <span class="comment">// 消息接受者的父类</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>4.根据上面的代码和源码可以得出<code>[super run ]</code>转换后的代码</p>
<p><code>objc_msgSendSuper(&#123;self,person&#125;, @selector(run));</code></p>
</blockquote>
<blockquote>
<p>5.查看<code>objc_msgSendSuper</code>的源码，在<code>message.h</code>中，找到如下的注释</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 从父类的方法列表里开始查找方法实现</span><br><span class="line">the superclass at which to start searching for the method implementation.</span><br></pre></td></tr></table></figure>

<p><strong>结论</strong>：<code>super</code>方法，只是从父类对象开始找出方法实现，但是<code>receiver</code>还是当前类</p>
<blockquote>
<p>[super message]的底层实现</p>
<ul>
<li>1.消息接收者仍然是子类对象</li>
<li>2.从父类开始查找方法的实现</li>
</ul>
</blockquote>
<p>回到开始的问题：<code>[super class]</code> 的打印值，就牵扯到<code>class</code>的方法实现，在<code>NSObject.mm</code> 中查看 <code>class</code>、<code>superclass</code>的源码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+ (Class)<span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)<span class="keyword">class</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> object_getClass(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (Class)superclass &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>-&gt;getSuperclass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (Class)superclass &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> <span class="keyword">class</span>]-&gt;getSuperclass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>结论</strong>：<code>[super class]</code> 打印出来的是<code>recever</code>，也就是<code>student</code></p>
<h4><span id="iskindofclass-he-ismemberofclass">isKindOfClass 和 isMemberOfClass</span><a href="#iskindofclass-he-ismemberofclass" class="header-anchor">#</a></h4><p>在<code>NSObject.mm</code> 中找到源码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断cls对象，是否是self的元类</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>-&gt;ISA() == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断cls是否是[self class]</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> <span class="keyword">class</span>] == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断cls对象，是否是self的元类、或者self的元类的父类</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class tcls = <span class="keyword">self</span>-&gt;ISA(); tcls; tcls = tcls-&gt;getSuperclass()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断cls是否是[self class]，或者[self class]的父类</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">for</span> (Class tcls = [<span class="keyword">self</span> <span class="keyword">class</span>]; tcls; tcls = tcls-&gt;getSuperclass()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tcls == cls) <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3><span id="runtime-ji-ben-han-shu">runtime基本函数</span><a href="#runtime-ji-ben-han-shu" class="header-anchor">#</a></h3><h4><span id="api">API</span><a href="#api" class="header-anchor">#</a></h4><h5><span id="lei">类</span><a href="#lei" class="header-anchor">#</a></h5><p>动态创建一个类（参数：父类，类名，额外的内存空间）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class objc_allocateClassPair(Class superclass, <span class="keyword">const</span> <span class="keyword">char</span> *name, size_t extraBytes)</span><br></pre></td></tr></table></figure>

<p>注册一个类（要在类注册之前添加成员变量），成员变量在<code>class_ro_t</code>结构体中是只读的，没法在创建完类后动态添加成员变量</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> objc_registerClassPair(Class cls) </span><br></pre></td></tr></table></figure>
<p>销毁一个类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> objc_disposeClassPair(Class cls)</span><br></pre></td></tr></table></figure>


<p>获取isa指向的Class</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class object_getClass(<span class="keyword">id</span> obj)</span><br></pre></td></tr></table></figure>


<p>设置isa指向的Class</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class object_setClass(<span class="keyword">id</span> obj, Class cls)</span><br></pre></td></tr></table></figure>


<p>判断一个OC对象是否为Class</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> object_isClass(<span class="keyword">id</span> obj)</span><br></pre></td></tr></table></figure>


<p>判断一个Class是否为元类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> class_isMetaClass(Class cls)</span><br></pre></td></tr></table></figure>


<p>获取父类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class class_getSuperclass(Class cls)</span><br></pre></td></tr></table></figure>

<h5><span id="cheng-yuan-bian-liang">成员变量</span><a href="#cheng-yuan-bian-liang" class="header-anchor">#</a></h5><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6d0e8b27f78416da8bf755e0874bc41~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-22 下午2.28.18.png"></p>
<p><code>Ivar *class_copyIvarList(Class cls, unsigned int *outCount)</code> 常用，使用最后要调用<code>free</code>释放</p>
<h5><span id="shu-xing">属性</span><a href="#shu-xing" class="header-anchor">#</a></h5><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/461069831368408880a92f6d2c139620~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-22 下午5.12.47.png"></p>
<h5><span id="fang-fa">方法</span><a href="#fang-fa" class="header-anchor">#</a></h5><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d725a7c6f6f64a229161b20d3cf053d6~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-22 下午5.13.14.png"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dff60d2baf340bc974d81cf563556ff~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-22 下午5.13.36.png"></p>
<ol>
<li><p>查看类的属性、方法、成员变量、协议</p>
</li>
<li><p>字典转模型</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)mj_objectWithJson:(<span class="built_in">NSDictionary</span> *)json;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSObject+Json.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Json</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)mj_objectWithJson:(<span class="built_in">NSDictionary</span> *)json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> obj = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">    Ivar *ivars = class_copyIvarList(<span class="keyword">self</span>, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="comment">// 取出i位置的成员变量</span></span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        <span class="built_in">NSMutableString</span> *name = [<span class="built_in">NSMutableString</span> stringWithUTF8String:ivar_getName(ivar)];</span><br><span class="line">        [name deleteCharactersInRange:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设值</span></span><br><span class="line">        <span class="keyword">id</span> value = json[name];</span><br><span class="line">        <span class="keyword">if</span> ([name isEqualToString:<span class="string">@&quot;ID&quot;</span>]) &#123;</span><br><span class="line">            value = json[<span class="string">@&quot;id&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        [obj setValue:value forKey:name];</span><br><span class="line">    &#125;</span><br><span class="line">    free(ivars);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>替换方法实现</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;UIControl+Extension.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIControl</span> (<span class="title">Extension</span>)</span></span><br><span class="line"><span class="comment">// 交换按钮点击事件，会调用sendAction:to:forEvent:方法，交换方法实现</span></span><br><span class="line">+ (<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// hook：钩子函数</span></span><br><span class="line">    Method method1 = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(sendAction:to:forEvent:));</span><br><span class="line">    Method method2 = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(mj_sendAction:to:forEvent:));</span><br><span class="line">    <span class="comment">// 会清空缓存</span></span><br><span class="line">    method_exchangeImplementations(method1, method2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)mj_sendAction:(SEL)action to:(<span class="keyword">id</span>)target forEvent:(<span class="built_in">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@-%@-%@&quot;</span>, <span class="keyword">self</span>, target, <span class="built_in">NSStringFromSelector</span>(action));</span><br><span class="line">    <span class="comment">// 调用系统原来的实现</span></span><br><span class="line">    [<span class="keyword">self</span> mj_sendAction:action to:target forEvent:event];</span><br><span class="line"><span class="comment">//    if ([self isKindOfClass:[UIButton class]]) &#123;</span></span><br><span class="line"><span class="comment">//        // 拦截了所有按钮的事件</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>查看 <code>method_exchangeImplementations</code> 的源码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> method_exchangeImplementations(Method m1, Method m2)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m1  ||  !m2) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line"></span><br><span class="line">    IMP imp1 = m1-&gt;imp(<span class="literal">false</span>);</span><br><span class="line">    IMP imp2 = m2-&gt;imp(<span class="literal">false</span>);</span><br><span class="line">    SEL sel1 = m1-&gt;name();</span><br><span class="line">    SEL sel2 = m2-&gt;name();</span><br><span class="line">     <span class="comment">// 交换两个method的imp</span></span><br><span class="line">    m1-&gt;setImp(imp2);</span><br><span class="line">    m2-&gt;setImp(imp1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冲洗缓存，这个方法会清空缓存</span></span><br><span class="line">    flushCaches(<span class="literal">nil</span>, __func__, [sel1, sel2, imp1, imp2](Class c)&#123;</span><br><span class="line">        <span class="keyword">return</span> c-&gt;cache.shouldFlush(sel1, imp1) || c-&gt;cache.shouldFlush(sel2, imp2);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    adjustCustomFlagsForMethodChange(<span class="literal">nil</span>, m1);</span><br><span class="line">    adjustCustomFlagsForMethodChange(<span class="literal">nil</span>, m2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过源码可以看出<code>method_exchangeImplementations</code>本质是交换两个<code>method</code>中的<code>imp</code></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a74bdf5ed6d47a29c2ce7bc4df2c1b8~tplv-k3u1fbpfcp-watermark.image" alt="截屏2021-03-22 下午4.22.58.png"></p>
<p><code>object_getClass</code>: 本质是获取<code>isa</code>指向的<code>class</code></p>
<p><code>object_setClass</code>： 设置<code>isa</code>指向的<code>class</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line">[person run];</span><br><span class="line">object_setClass(person, [Car <span class="keyword">class</span>]);</span><br><span class="line">[person run];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果：可以发现对象的isa指针指向的类对象，被替换掉了</span></span><br><span class="line">-[JXPerson run]</span><br><span class="line">-[Car run]</span><br></pre></td></tr></table></figure>

<p>交换方法实现</p>
<p><strong>设置动态数组，添加nil防止崩溃</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSMutableArray+Extension.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableArray</span> (<span class="title">Extension</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// 类簇：NSString、NSArray、NSDictionary，真实类型是其他类型</span></span><br><span class="line">        <span class="comment">//类簇是Foundation框架中广泛使用的设计模式。类簇将一些私有的、具体的子类组合在一个公共的、抽象的超类下面，以这种方法来组织类可以简化一个面向对象框架的公开架构，而又不减少功能的丰富性。</span></span><br><span class="line">        Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@&quot;__NSArrayM&quot;</span>);</span><br><span class="line">        Method method1 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(insertObject:atIndex:));</span><br><span class="line">        Method method2 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(mj_insertObject:atIndex:));</span><br><span class="line">        method_exchangeImplementations(method1, method2);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)mj_insertObject:(<span class="keyword">id</span>)anObject atIndex:(<span class="built_in">NSUInteger</span>)index</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (anObject == <span class="literal">nil</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> mj_insertObject:anObject atIndex:index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>设置字典的key为nil的情况</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSMutableDictionary+Extension.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableDictionary</span> (<span class="title">Extension</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@&quot;__NSDictionaryM&quot;</span>);</span><br><span class="line">        Method method1 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(setObject:forKeyedSubscript:));</span><br><span class="line">        Method method2 = class_getInstanceMethod(cls, <span class="keyword">@selector</span>(mj_setObject:forKeyedSubscript:));</span><br><span class="line">        method_exchangeImplementations(method1, method2);</span><br><span class="line">        </span><br><span class="line">        Class cls2 = <span class="built_in">NSClassFromString</span>(<span class="string">@&quot;__NSDictionaryI&quot;</span>);</span><br><span class="line">        Method method3 = class_getInstanceMethod(cls2, <span class="keyword">@selector</span>(objectForKeyedSubscript:));</span><br><span class="line">        Method method4 = class_getInstanceMethod(cls2, <span class="keyword">@selector</span>(mj_objectForKeyedSubscript:));</span><br><span class="line">        method_exchangeImplementations(method3, method4);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)mj_setObject:(<span class="keyword">id</span>)obj forKeyedSubscript:(<span class="keyword">id</span>&lt;<span class="built_in">NSCopying</span>&gt;)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> mj_setObject:obj forKeyedSubscript:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)mj_objectForKeyedSubscript:(<span class="keyword">id</span>)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!key) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> mj_objectForKeyedSubscript:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>












</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a target="_blank" rel="noopener" href="http://twitter.com/home?status=http://example.com/2021/03/08/底层五：Runtime/%20Hexo%20底层五：Runtime" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2021/03/08/%E5%BA%95%E5%B1%82%E4%B8%89%EF%BC%9Acategory/" title="底层三：Category"><i class="fa fa-angle-double-left"></i>&nbsp;Previous post: 底层三：Category</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2021/03/08/%E5%BA%95%E5%B1%82%E5%9B%9B%EF%BC%9Ablock/" title="底层四：block">Next post: 底层四：block&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://example.com" rel="noopener noreferrer">John Doe</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>