<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>底层二：KVO、KVC · Hexo</title><meta name="description" content="KVO#
通过打印被监听实例对象的isa指针，可以发现，被监听实例对象的isa不再指向类对象，而是指向NSKVONotifying_MJPerson
NSKVONotifying_MJPerson是使用Runtime动态创建的一个类，是MJPerson的子类

NSKVONotifying_MJPe"><meta name="keywords" content=""><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 5.4.0"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">生活</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">聊聊</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/tags">Tags</a></li><li><a href="/tags/index.html"></a></li><li class="soc"><a href="http://example.com/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://example.com" rel="noopener noreferrer">John Doe</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>底层二：KVO、KVC</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2021-03-08</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/底层/" title="底层" class="a-tag">底层</a><span>&nbsp;</span></span></p><p class="post-abstract"><h4><span id="kvo">KVO</span><a href="#kvo" class="header-anchor">#</a></h4><ul>
<li>通过打印<code>被监听实例对象</code>的<code>isa</code>指针，可以发现，被监听实例对象的<code>isa</code>不再指向类对象，而是指向<code>NSKVONotifying_MJPerson</code></li>
<li><code>NSKVONotifying_MJPerson</code>是使用<code>Runtime</code>动态创建的一个类，是<code>MJPerson</code>的子类</li>
</ul>
<p><code>NSKVONotifying_MJPerson</code> 伪代码 </p>
<ul>
<li> 通过<code>[self.person1 methodForSelector:@selector(setAge:)]</code>获取方法实现的地址</li>
<li>通过LLDB 的命令<code>p (IMP)0x1069189e4</code> 获取方法的名称</li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90a57963daa04a68b34827ab6ae3656d~tplv-k3u1fbpfcp-watermark.image" alt="未命名.png"> </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;MJPerson.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSKVONotifying_MJPerson</span> : <span class="title">MJPerson</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSKVONotifying_MJPerson.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSKVONotifying_MJPerson</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setAge:(<span class="keyword">int</span>)age</span><br><span class="line">&#123;</span><br><span class="line">    _NSSetIntValueAndNotify();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 伪代码</span></span><br><span class="line"><span class="keyword">void</span> _NSSetIntValueAndNotify()</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;age&quot;</span>];</span><br><span class="line">    [<span class="keyword">super</span> setAge:age];</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;age&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)didChangeValueForKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 通知监听器，某某属性值发生了改变</span></span><br><span class="line">    [oberser observeValueForKeyPath:key ofObject:<span class="keyword">self</span> change:<span class="literal">nil</span> context:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>NSKVONotifying_MJPerson</code> <code>类对象</code>指向自己的<code>元类对象</code></p>
<blockquote>
<p>未使用KVO监听的对象</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/294b9e145f2547e7b7071aa0dfd64446~tplv-k3u1fbpfcp-zoom-1.image" alt="kvo1.png"></p>
<blockquote>
<p>使用KVO监听的对象</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/451faca4c49344a6a28abafd74ca9f76~tplv-k3u1fbpfcp-zoom-1.image" alt="kvo2.png"></p>
<blockquote>
<p><strong>总结</strong>：使用了<code>KVO</code>，会产生一个<code>MJPerson</code>的子类(<code>NSKVONotifying_MJPerson</code>)，会改变<code>MJPerson</code>的<code>isa</code>指向新产生的子类，同时在新的子类里面会重写<code>setAge:</code>方法，以及新增三个方法</p>
</blockquote>
<p>获取方法数组</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)printMethodNamesOfClass:(Class)cls</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="comment">// 获得方法数组</span></span><br><span class="line">    Method *methodList = class_copyMethodList(cls, &amp;count);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 存储方法名</span></span><br><span class="line">    <span class="built_in">NSMutableString</span> *methodNames = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历所有的方法</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="comment">// 获得方法</span></span><br><span class="line">        Method method = methodList[i];</span><br><span class="line">        <span class="comment">// 获得方法名</span></span><br><span class="line">        <span class="built_in">NSString</span> *methodName = <span class="built_in">NSStringFromSelector</span>(method_getName(method));</span><br><span class="line">        <span class="comment">// 拼接方法名</span></span><br><span class="line">        [methodNames appendString:methodName];</span><br><span class="line">        [methodNames appendString:<span class="string">@&quot;, &quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 释放</span></span><br><span class="line">    free(methodList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打印方法名</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@&quot;</span>, cls, methodNames);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到 NSKVONotifying_MJPerson 内部的方法名</p>
<table>
<thead>
<tr>
<th>NSKVONotifying_MJPerson</th>
<th>类型</th>
<th>实现</th>
</tr>
</thead>
<tbody><tr>
<td><code>setAge:</code></td>
<td>重写</td>
<td>实现<code>Foundation</code>的<code>_NSSetIntValueAndNotify</code>方法</td>
</tr>
<tr>
<td><code>class</code></td>
<td>新增</td>
<td>屏蔽内部实现，隐藏了<code>NSKVONotifying_MJPerson</code>类对象</td>
</tr>
<tr>
<td><code>dealloc</code></td>
<td>新增</td>
<td>清理现场</td>
</tr>
<tr>
<td><code>_isKVOA</code></td>
<td>新增</td>
<td></td>
</tr>
</tbody></table>
<p><code>_NSSetIntValueAndNotify</code>内部实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. [self willChangeValueForKey:@&quot;age&quot;]</span><br><span class="line">2. 原来的setter实现</span><br><span class="line">3. [self didChangeValueForKey:@&quot;age&quot;]</span><br><span class="line"></span><br><span class="line">didChangeValueForKey:内部会调用observer的observeValueForKeyPath:ofObject:change:context:方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>_NSSet*ValueAndNotify</code> 包括很多的基本数据类型<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf4db93f991d4a71be2db5b479d8ecb2~tplv-k3u1fbpfcp-zoom-1.image" alt="kvo3.png"></p>
<h4><span id="kvc">KVC</span><a href="#kvc" class="header-anchor">#</a></h4><p>使用<code>KVC</code>设置属性时候，会触发<code>KVO</code>,即使没有set方法，也会触发KVO，因为KVC底层调用了<code>- (void)willChangeValueForKey:(NSString *)key</code> 和 <code>- (void)didChangeValueForKey:(NSString *)key</code> 两个方法</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/be0279c442104cb1a6a360f0895eb987~tplv-k3u1fbpfcp-zoom-1.image" alt="kvc1.png"><br>举例： 查找顺序(属性名为<code>age</code>) <code>_age</code> <code>_isAge</code> <code>age</code> <code>isAge</code></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/626c3898dadc4ce18b25faa3626f1f25~tplv-k3u1fbpfcp-zoom-1.image" alt="kvc2.png"></p>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a target="_blank" rel="noopener" href="http://twitter.com/home?status=http://example.com/2021/03/08/底层二：KVO、KVC/%20Hexo%20底层二：KVO、KVC" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2021/03/08/%E5%BA%95%E5%B1%82%E4%B8%80%EF%BC%9A%E5%AF%B9%E8%B1%A1/" title="底层一：OC对象"><i class="fa fa-angle-double-left"></i>&nbsp;Previous post: 底层一：OC对象</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2021/03/08/%E5%BA%95%E5%B1%82%E5%85%AD%EF%BC%9ArunLoop/" title="底层六：runLoop">Next post: 底层六：runLoop&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://example.com" rel="noopener noreferrer">John Doe</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>